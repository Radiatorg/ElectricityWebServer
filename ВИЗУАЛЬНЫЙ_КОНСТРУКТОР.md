# Визуальный конструктор планировок - Реализованный функционал

## Backend (Spring Boot)

### Новые Entity модели

1. **FloorPlan** - Планировка проекта
   - Связь с проектом (OneToOne)
   - Ширина, высота, масштаб
   - Связи со стенами и электрическими точками

2. **Wall** - Стена
   - Координаты начала и конца (startX, startY, endX, endY)
   - Толщина стены
   - Тип стены (external, internal, load_bearing)
   - Проемы (двери, окна)

3. **WallOpening** - Проем в стене
   - Позиция на стене
   - Ширина и высота
   - Тип проема (door, window, arch)

4. **ElectricalPoint** - Электрическая точка на плане
   - Позиция (X, Y)
   - Связь с символом (ElectricalSymbol)
   - Связь с помещением (Room)
   - Высота от пола
   - Поворот
   - Группа для управления

5. **ElectricalSymbol** - Символ электрического элемента
   - Название
   - SVG путь для отрисовки
   - Тип (outlet, switch, light, panel, junction_box)
   - Категория
   - Размеры по умолчанию

6. **PlacementRule** - Правила размещения элементов
   - Тип элемента
   - Минимальные/максимальные расстояния
   - Рекомендуемые высоты

### Обновленные модели

- **Room** - добавлены поля для визуального отображения:
  - positionX, positionY - координаты
  - width, height - размеры
  - polygonPoints - JSON массив точек для полигона

### API Endpoints

#### Floor Plan
- `GET /api/designer/projects/{projectId}/floor-plan` - Получить планировку
- `POST /api/designer/projects/{projectId}/floor-plan` - Создать/обновить планировку
- `PUT /api/designer/projects/{projectId}/floor-plan` - Обновить планировку
- `DELETE /api/designer/projects/{projectId}/floor-plan` - Удалить планировку

#### Walls
- `GET /api/designer/projects/{projectId}/walls` - Получить все стены
- `POST /api/designer/projects/{projectId}/walls` - Создать стену
- `POST /api/designer/projects/{projectId}/walls/batch` - Сохранить несколько стен
- `PUT /api/designer/projects/{projectId}/walls/{wallId}` - Обновить стену
- `DELETE /api/designer/projects/{projectId}/walls/{wallId}` - Удалить стену

#### Electrical Points
- `GET /api/designer/projects/{projectId}/electrical-points` - Получить все точки
- `POST /api/designer/projects/{projectId}/electrical-points` - Создать точку
- `POST /api/designer/projects/{projectId}/electrical-points/batch` - Сохранить несколько точек
- `PUT /api/designer/projects/{projectId}/electrical-points/{pointId}` - Обновить точку
- `DELETE /api/designer/projects/{projectId}/electrical-points/{pointId}` - Удалить точку

#### Electrical Symbols
- `GET /api/electrical-symbols` - Получить все символы
- `GET /api/electrical-symbols/type/{type}` - Получить символы по типу
- `GET /api/electrical-symbols/category/{category}` - Получить символы по категории
- `GET /api/electrical-symbols/{id}` - Получить символ по ID
- `POST /api/admin/electrical-symbols` - Создать символ (ADMIN)
- `PUT /api/admin/electrical-symbols/{id}` - Обновить символ (ADMIN)
- `DELETE /api/admin/electrical-symbols/{id}` - Удалить символ (ADMIN)

### Сервисы

- **FloorPlanService** - Управление планировками
- **WallService** - Управление стенами
- **ElectricalPointService** - Управление электрическими точками
- **ElectricalSymbolService** - Управление символами

---

## Frontend (React)

### Новые компоненты

1. **FloorPlanCanvas** (`components/FloorPlanCanvas/FloorPlanCanvas.js`)
   - Canvas для отрисовки планировки
   - Отрисовка сетки
   - Отрисовка помещений (прямоугольники и полигоны)
   - Отрисовка стен
   - Отрисовка электрических точек
   - Панорамирование (перетаскивание)
   - Масштабирование (колесико мыши)
   - Привязка к сетке
   - Инструменты: выбор, помещение, стена, элемент

2. **ElectricalSymbolsLibrary** (`components/ElectricalSymbolsLibrary/ElectricalSymbolsLibrary.js`)
   - Библиотека электрических символов
   - Фильтрация по типу и категории
   - Выбор символа для размещения на плане
   - Визуальное отображение символов

3. **FloorPlanEditor** (`pages/FloorPlanEditor.js`)
   - Главная страница визуального редактора
   - Интеграция FloorPlanCanvas и ElectricalSymbolsLibrary
   - Загрузка данных планировки
   - Обновление элементов на плане
   - Создание новых электрических точек

### Обновленные компоненты

- **ProjectDetail** - добавлена кнопка "Визуальный редактор"
- **api.js** - добавлены новые API методы для работы с планировками

### Новые страницы

- `/projects/:projectId/floor-plan` - Визуальный редактор планировки

---

## Функциональность

### Реализовано

✅ Создание и редактирование планировок
✅ Отрисовка помещений (прямоугольники и полигоны)
✅ Отрисовка стен с проемами
✅ Отрисовка электрических точек
✅ Библиотека электрических символов
✅ Сетка для точного размещения
✅ Привязка к сетке
✅ Масштабирование (zoom)
✅ Панорамирование (pan)
✅ Drag & Drop для перемещения элементов
✅ Фильтрация символов по типу и категории
✅ Интеграция с существующими проектами

### Частично реализовано

⚠️ Ресайз помещений (базовая структура готова, нужна доработка)
⚠️ Рисование стен (отрисовка есть, создание через UI нужно доработать)
⚠️ Создание помещений через UI (структура готова, нужна доработка)

### Требует доработки

❌ Мебель для масштабирования (FurnitureLibrary)
❌ Полигональные помещения (создание через UI)
❌ Редактирование проемов в стенах
❌ Валидация размещения элементов по правилам (PlacementRule)
❌ Экспорт планировки в изображение
❌ Печать планировки

---

## Использование

### Запуск визуального редактора

1. Откройте проект в списке проектов
2. Нажмите кнопку "Визуальный редактор"
3. Или перейдите по адресу: `/projects/{projectId}/floor-plan`

### Работа с редактором

1. **Выбор инструмента** - используйте панель инструментов вверху слева
2. **Размещение символов** - выберите символ в библиотеке справа, затем кликните на плане
3. **Перемещение элементов** - выберите инструмент "Выбор", затем перетащите элемент
4. **Масштабирование** - используйте колесико мыши
5. **Панорамирование** - зажмите левую кнопку мыши и перемещайте курсор

---

## Технические детали

### Координаты

Все координаты хранятся в сантиметрах (см) относительно левого верхнего угла планировки.

### Масштаб

Масштаб определяет соотношение между реальными размерами (см) и пикселями на экране.

### Сетка

Сетка помогает точно размещать элементы. Размер сетки по умолчанию: 20 см.

### Привязка к сетке

При включенной привязке координаты автоматически округляются до ближайшей точки сетки.

---

## Следующие шаги

1. Доработать создание помещений через UI
2. Доработать создание стен через UI
3. Добавить библиотеку мебели
4. Реализовать валидацию размещения по правилам
5. Добавить экспорт планировки
6. Улучшить UI/UX
7. Добавить undo/redo функциональность
8. Добавить слои (layers) для разных типов элементов

