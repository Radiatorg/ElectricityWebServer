# Логика коэффициентов мощности помещений

## Описание

Коэффициент мощности помещения - это множитель, используемый для расчета общей мощности электроприборов в помещении с учетом специфики типа помещения.

## Формула расчета

```
Итоговая_мощность_помещения = Сумма_мощностей_всех_приборов × Коэффициент_помещения
```

## Типы коэффициентов

### 1. Одно значение (фиксированный коэффициент)

Если задан только `minCoefficient`:
- Используется значение `minCoefficient` напрямую
- Пример: `minCoefficient = 1.2` → используется `1.2`

### 2. Диапазон (вилка)

Если заданы и `minCoefficient`, и `maxCoefficient`:
- Используется среднее значение: `(minCoefficient + maxCoefficient) / 2`
- Пример: `minCoefficient = 1.0`, `maxCoefficient = 1.5` → используется `1.25`

## Правила валидации

1. **Минимальный коэффициент** (`minCoefficient`):
   - Обязательное поле
   - Должен быть больше 0
   - Рекомендуемый диапазон: 0.1 - 10.0

2. **Максимальный коэффициент** (`maxCoefficient`):
   - Опциональное поле
   - Если задан, должен быть больше 0
   - Должен быть больше или равен `minCoefficient`

3. **Проверки в базе данных**:
   - `min_coefficient > 0` (CHECK constraint)
   - `max_coefficient IS NULL OR (max_coefficient > 0 AND max_coefficient >= min_coefficient)` (CHECK constraint)

## Примеры использования

### Пример 1: Жилая комната
- `minCoefficient = 1.0`
- `maxCoefficient = null`
- **Используемый коэффициент**: `1.0`
- **Расчет**: Если сумма мощностей приборов = 2000 Вт, то итоговая мощность = 2000 × 1.0 = 2000 Вт

### Пример 2: Кухня (с диапазоном)
- `minCoefficient = 1.2`
- `maxCoefficient = 1.5`
- **Используемый коэффициент**: `(1.2 + 1.5) / 2 = 1.35`
- **Расчет**: Если сумма мощностей приборов = 3000 Вт, то итоговая мощность = 3000 × 1.35 = 4050 Вт

### Пример 3: Ванная комната
- `minCoefficient = 1.1`
- `maxCoefficient = null`
- **Используемый коэффициент**: `1.1`
- **Расчет**: Если сумма мощностей приборов = 1500 Вт, то итоговая мощность = 1500 × 1.1 = 1650 Вт

## Реализация в коде

### Backend (Java)

```java
// Получение эффективного коэффициента
public BigDecimal getEffectiveCoefficient() {
    if (maxCoefficient != null && maxCoefficient.compareTo(minCoefficient) > 0) {
        return minCoefficient.add(maxCoefficient)
            .divide(BigDecimal.valueOf(2), 4, RoundingMode.HALF_UP);
    }
    return minCoefficient;
}

// Использование в расчетах
BigDecimal roomCoefficient = room.getRoomType().getEffectiveCoefficient();
BigDecimal roomPower = rawRoomPower.multiply(roomCoefficient);
```

### Frontend (React)

```javascript
// Отображение эффективного коэффициента
const effectiveCoefficient = roomType.maxCoefficient 
  ? (parseFloat(roomType.minCoefficient) + parseFloat(roomType.maxCoefficient)) / 2
  : parseFloat(roomType.minCoefficient);
```

## Миграция базы данных

Перед запуском обновленного приложения необходимо выполнить SQL-скрипт:
```sql
-- См. файл migration_add_coefficients.sql
```

## Рекомендации по значениям

| Тип помещения | Рекомендуемый minCoefficient | Рекомендуемый maxCoefficient |
|---------------|------------------------------|------------------------------|
| Жилая комната | 1.0 | - |
| Кухня | 1.2 | 1.5 |
| Ванная | 1.1 | - |
| Коридор | 0.8 | 1.0 |
| Кладовка | 0.5 | - |

## Важные замечания

1. **Однозначность**: Все неоднозначные моменты устранены:
   - Если задан диапазон, всегда используется среднее значение
   - Если диапазон не задан, используется минимальное значение
   - Валидация гарантирует корректность данных

2. **Обратная совместимость**: 
   - Существующие записи получат значение по умолчанию `1.0`
   - Старые API продолжают работать

3. **Точность расчетов**:
   - Коэффициенты хранятся с точностью до 4 знаков после запятой
   - Расчеты выполняются с округлением до 4 знаков


